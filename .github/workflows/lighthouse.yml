name: Lighthouse CI

on:
  schedule:
    - cron: '0 */6 * * *' # every 6 hours
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  lhci:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Chromium (required for LHCI / Lighthouse)
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser || sudo apt-get install -y chromium

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.10.x

      - name: Run Lighthouse CI autorun (write to latest)
        env:
          TARGET_URL: https://flip-rabbit.webflow.io
        run: |
          set -euo pipefail

          REPORT_DIR="./lhci-report/latest"
          rm -rf "$REPORT_DIR"
          mkdir -p "$REPORT_DIR"

          echo "Running lhci autorun and saving to $REPORT_DIR"

          # Run LHCI; outputs html + json into REPORT_DIR
          # Use --chrome-flags "--no-sandbox" for CI runner
          lhci autorun \
            --collect.url="$TARGET_URL" \
            --collect.numberOfRuns=3 \
            --upload.target=filesystem \
            --upload.outputDir="$REPORT_DIR" \
            --collect.settings.chromeFlags="--no-sandbox"

      - name: Create index inside latest and root redirect
        run: |
          set -euo pipefail
          LATEST_DIR="./lhci-report/latest"
          ROOT_INDEX="./lhci-report/index.html"

          mapfile -t htmlfiles < <(find "$LATEST_DIR" -maxdepth 1 -type f -iname '*.html' -printf '%f\n' | sort)

          if [ ${#htmlfiles[@]} -eq 0 ]; then
            cat > "${LATEST_DIR}/index.html" <<HTML
          <!doctype html><html><head><meta charset="utf-8"><title>Latest Reports</title></head><body>
          <h1>Latest Reports</h1>
          <p>No HTML report files were found in this folder.</p>
          </body></html>
          HTML
          else
            first=${htmlfiles[0]}
            cat > "${LATEST_DIR}/index.html" <<HTML
          <!doctype html><html><head><meta charset="utf-8"><title>Latest Reports</title>
          <!-- Auto-redirect to first report -->
          <meta http-equiv="refresh" content="0;url=${first}">
          </head><body>
          <h1>Latest Reports</h1>
          <ul>
          HTML
            for f in "${htmlfiles[@]}"; do
              echo "<li><a href=\"$f\">$f</a></li>" >> "${LATEST_DIR}/index.html"
            done
            echo "</ul></body></html>" >> "${LATEST_DIR}/index.html"
          fi

          # Create a root index.html that redirects to /latest/
          cat > "$ROOT_INDEX" <<HTML
          <!doctype html><html><head><meta charset="utf-8"><title>Lighthouse Reports</title>
          <meta http-equiv="refresh" content="0;url=latest/">
          </head><body>
          <h1>Lighthouse Reports</h1>
          <p>Redirecting to the latest report...</p>
          <p>If your browser doesn't redirect, <a href="latest/">click here</a>.</p>
          </body></html>
          HTML

      - name: Debug - show files to be deployed
        run: |
          echo "=== lhci-report tree ==="
          ls -laR ./lhci-report || true
          echo "=== head of latest/index.html ==="
          sed -n '1,200p' ./lhci-report/latest/index.html || true
          echo "=== head of root index.html ==="
          sed -n '1,200p' ./lhci-report/index.html || true

      - name: Deploy reports to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./lhci-report
          publish_branch: gh-pages
