name: Lighthouse CI (Client Reports)

on:
  schedule:
    - cron: '0 */6 * * *'  # every 6 hours
  workflow_dispatch:

jobs:
  lhci:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.10.x

      - name: Run Lighthouse CI autorun (for client website)
        env:
          TARGET_URL: https://blixa.webflow.io   # ðŸ‘ˆ Change this to clientâ€™s actual domain when live
        run: |
          set -euo pipefail

          TIMESTAMP=$(date +"%Y_%m_%d_%H_%M_%S")
          REPORT_ROOT="./lhci-report"
          LATEST_DIR="${REPORT_ROOT}/latest"
          ARCHIVE_DIR="${REPORT_ROOT}/archive/${TIMESTAMP}"

          # Clean up previous 'latest' directory
          rm -rf "$LATEST_DIR"
          mkdir -p "$LATEST_DIR" "$ARCHIVE_DIR"

          echo "Running Lighthouse CI for $TARGET_URL"
          lhci autorun \
            --collect.url="$TARGET_URL" \
            --upload.target=filesystem \
            --upload.outputDir="$LATEST_DIR"

          echo "Saving a timestamped copy in archive/"
          cp -r "$LATEST_DIR"/* "$ARCHIVE_DIR"/

      - name: Create index files (auto-redirect + archive list)
        run: |
          set -euo pipefail
          REPORT_ROOT="./lhci-report"
          LATEST_DIR="${REPORT_ROOT}/latest"
          ROOT_INDEX="${REPORT_ROOT}/index.html"

          # Generate an index for /latest/
          mapfile -t htmlfiles < <(find "$LATEST_DIR" -maxdepth 1 -type f -iname '*.html' -printf '%f\n' | sort)

          if [ ${#htmlfiles[@]} -eq 0 ]; then
            cat > "${LATEST_DIR}/index.html" <<HTML
          <!doctype html><html><head><meta charset="utf-8"><title>No Reports</title></head><body>
          <h1>No Lighthouse Reports Found</h1>
          </body></html>
          HTML
          else
            first=${htmlfiles[0]}
            cat > "${LATEST_DIR}/index.html" <<HTML
          <!doctype html><html><head><meta charset="utf-8"><title>Latest Lighthouse Report</title>
          <meta http-equiv="refresh" content="0;url=${first}">
          </head><body>
          <h1>Redirecting to the Latest Lighthouse Report...</h1>
          <p>If not redirected automatically, <a href="${first}">click here</a>.</p>
          </body></html>
          HTML
          fi

          # Create a root index linking to latest and archives
          cat > "$ROOT_INDEX" <<HTML
          <!doctype html><html><head><meta charset="utf-8"><title>Lighthouse Reports</title></head><body>
          <h1>Lighthouse Reports</h1>
          <ul>
            <li><a href="latest/">View Latest Report</a></li>
            <li><a href="archive/">View Archived Reports</a></li>
          </ul>
          </body></html>
          HTML

      - name: Debug (optional)
        run: |
          echo "=== Report Folder Structure ==="
          ls -laR ./lhci-report || true

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./lhci-report
          publish_branch: gh-pages
