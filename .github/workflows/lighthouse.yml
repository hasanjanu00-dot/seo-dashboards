name: Lighthouse CI (Client Reports)

on:
  schedule:
    - cron: '0 */6 * * *'  # every 6 hours
  workflow_dispatch:

jobs:
  lhci:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.10.x

      # 🧹 Clean up all old reports before creating a new one
      - name: Clean old reports
        run: rm -rf ./lhci-report

      # ⚡ Run Lighthouse CI for client website (flip-rabbit)
      - name: Run Lighthouse CI autorun (Client)
        env:
          TARGET_URL: https://flip-rabbit.webflow.io  # 👈 your client's actual website
        run: |
          set -euo pipefail

          REPORT_ROOT="./lhci-report"
          LATEST_DIR="${REPORT_ROOT}/latest"
          mkdir -p "$LATEST_DIR"

          echo "Running Lighthouse CI for $TARGET_URL..."
          lhci autorun \
            --collect.url="$TARGET_URL" \
            --upload.target=filesystem \
            --upload.outputDir="$LATEST_DIR"

          # Rename report to always have a fixed name
          HTML_FILE=$(find "$LATEST_DIR" -type f -name "*.html" | head -n 1)
          if [ -n "$HTML_FILE" ]; then
            mv "$HTML_FILE" "${LATEST_DIR}/index.html"
          fi

      # 🏗️ Create index.html that redirects to the latest report
      - name: Create redirect index
        run: |
          set -euo pipefail
          REPORT_ROOT="./lhci-report"
          ROOT_INDEX="${REPORT_ROOT}/index.html"

          cat > "$ROOT_INDEX" <<HTML
          <!doctype html><html><head><meta charset="utf-8">
          <meta http-equiv="refresh" content="0;url=latest/">
          <title>Lighthouse Report</title></head>
          <body>
            <h1>Redirecting to the latest Lighthouse report...</h1>
            <p>If not redirected, <a href="latest/">click here</a>.</p>
          </body></html>
          HTML

      - name: Debug (optional)
        run: |
          echo "=== Final Folder Structure ==="
          ls -laR ./lhci-report || true

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./lhci-report
          publish_branch: gh-pages
